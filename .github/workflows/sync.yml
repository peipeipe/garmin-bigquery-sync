name: Sync Garmin Data to BigQuery

on:
  # Run daily at 9 PM UTC
  schedule:
    - cron: '0 21 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache GarminDB data
        uses: actions/cache@v4
        with:
          path: |
            ~/.GarminDb
            ~/.garth
          # Use date-based key to cache data for the day, allowing updates within the same day
          key: garmindb-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}-${{ github.run_number }}
          restore-keys: |
            garmindb-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}-
            garmindb-${{ runner.os }}-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Configure Garmin credentials
        run: |
          mkdir -p ~/.GarminDb
          cat > ~/.GarminDb/GarminConnectConfig.json << EOF
          {
            "credentials": {
              "user": "${{ secrets.GARMIN_USER }}",
              "password": "${{ secrets.GARMIN_PASSWORD }}"
            },
            "data": {
              "download_days": 3,
              "download_latest_activities": 10,
              "download_all_activities": 100
            }
          }
          EOF
          echo "Config file created at ~/.GarminDb/GarminConnectConfig.json"
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Import Garmin data
        id: import_data
        run: |
          # Download, import and analyze latest Garmin data
          # Using wrapper to prevent TypeError when stats is None
          # The wrapper also ensures config has proper defaults
          echo "Starting Garmin data import..."
          
          if python garmindb_wrapper.py --download --import --analyze --latest; then
            echo "import_status=success" >> $GITHUB_OUTPUT
            echo "‚úÖ Garmin data import completed successfully"
            exit 0
          else
            exit_code=$?
            # Check if database exists - if it does, we can still sync old data
            if [ -f ~/.GarminDb/garmin.db ]; then
              echo "import_status=no_new_data" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Garmin data import returned exit code $exit_code"
              echo "However, database exists from previous run. Will sync existing data."
              exit 0
            else
              echo "import_status=failed" >> $GITHUB_OUTPUT
              echo "‚ùå Garmin data import failed and no database exists"
              exit 1
            fi
          fi
      
      - name: Sync to BigQuery
        # Run if import was successful OR if import had no new data but database exists
        if: steps.import_data.outputs.import_status == 'success' || steps.import_data.outputs.import_status == 'no_new_data'
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          DATASET_ID: garmin_data
        run: |
          if [ "${{ steps.import_data.outputs.import_status }}" == "no_new_data" ]; then
            echo "‚ÑπÔ∏è No new data from Garmin, but syncing existing database to BigQuery..."
            echo "This ensures BigQuery tables are created/updated even without new data."
          else
            echo "Syncing new data to BigQuery..."
          fi
          
          if python sync_bq.py; then
            echo "‚úÖ BigQuery sync completed successfully"
          else
            echo "‚ùå BigQuery sync failed"
            exit 1
          fi
      
      - name: Display sync summary
        if: steps.import_data.outputs.import_status == 'success' || steps.import_data.outputs.import_status == 'no_new_data'
        run: |
          echo "üìä Sync completed for dataset: garmin_data"
          echo "Check the logs above for detailed row counts per table"
