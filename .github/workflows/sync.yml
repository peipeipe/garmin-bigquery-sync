name: Sync Garmin Data to BigQuery

on:
  # Run daily at 9 PM UTC (incremental update)
  schedule:
    - cron: '0 21 * * *'

  # Allow manual trigger with options
  workflow_dispatch:
    inputs:
      sync_mode:
        description: 'Sync mode'
        required: true
        default: 'incremental'
        type: choice
        options:
          - incremental
          - full_refresh

jobs:
  sync:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache GarminDB data
        uses: actions/cache@v4
        with:
          path: |
            ~/.GarminDb
            ~/.garth
            ~/HealthData
          # Use date-based key to cache data for the day, allowing updates within the same day
          key: garmindb-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}-${{ github.run_number }}
          restore-keys: |
            garmindb-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}-
            garmindb-${{ runner.os }}-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Configure Garmin credentials
        run: |
          mkdir -p ~/.GarminDb

          # Determine sync mode (default to incremental for scheduled runs)
          SYNC_MODE="${{ inputs.sync_mode || 'incremental' }}"
          echo "Sync mode: ${SYNC_MODE}"

          # Calculate date range based on sync mode
          if [ "$SYNC_MODE" == "full_refresh" ]; then
            # Full refresh: get ALL data from 2015-01-01
            START_DATE="2015-01-01"
            # Calculate days from 2015-01-01 to today
            DOWNLOAD_DAYS=$(( ($(date +%s) - $(date -d "2015-01-01" +%s)) / 86400 ))
            DOWNLOAD_ACTIVITIES=10000
          else
            # Incremental: get last 30 days
            START_DATE=$(date -d "30 days ago" +%Y-%m-%d)
            DOWNLOAD_DAYS=30
            DOWNLOAD_ACTIVITIES=50
          fi
          END_DATE=$(date +%Y-%m-%d)

          cat > ~/.GarminDb/GarminConnectConfig.json << EOF
          {
            "credentials": {
              "user": "${{ secrets.GARMIN_USER }}",
              "password": "${{ secrets.GARMIN_PASSWORD }}"
            },
            "data": {
              "download_days": ${DOWNLOAD_DAYS},
              "download_latest_activities": ${DOWNLOAD_ACTIVITIES},
              "download_all_activities": ${DOWNLOAD_ACTIVITIES},
              "monitoring_start_date": "${START_DATE}",
              "monitoring_end_date": "${END_DATE}",
              "activities_start_date": "${START_DATE}",
              "activities_end_date": "${END_DATE}",
              "sleep_start_date": "${START_DATE}",
              "sleep_end_date": "${END_DATE}",
              "rhr_start_date": "${START_DATE}",
              "rhr_end_date": "${END_DATE}",
              "weight_start_date": "${START_DATE}",
              "weight_end_date": "${END_DATE}"
            },
            "settings": {
              "metric": true
            }
          }
          EOF
          echo "Config file created at ~/.GarminDb/GarminConnectConfig.json"
          echo "Date range: ${START_DATE} to ${END_DATE}"
          echo "Download days: ${DOWNLOAD_DAYS}, Activities: ${DOWNLOAD_ACTIVITIES}"
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Import Garmin data
        id: import_data
        run: |
          # Download, import and analyze Garmin data
          # Using wrapper to prevent TypeError when stats is None
          SYNC_MODE="${{ inputs.sync_mode || 'incremental' }}"
          echo "Starting Garmin data import (mode: ${SYNC_MODE})..."

          # Build command based on sync mode
          if [ "$SYNC_MODE" == "full_refresh" ]; then
            echo "ğŸ”„ Full refresh mode: downloading all historical data..."
            CMD="python garmindb_wrapper.py --download --import --analyze"
          else
            echo "ğŸ“¥ Incremental mode: downloading latest data only..."
            CMD="python garmindb_wrapper.py --download --import --analyze --latest"
          fi

          if $CMD; then
            echo "import_status=success" >> $GITHUB_OUTPUT
            echo "sync_mode=${SYNC_MODE}" >> $GITHUB_OUTPUT
            echo "âœ… Garmin data import completed successfully"
            exit 0
          else
            exit_code=$?
            # Check if database exists - if it does, we can still sync old data
            if [ -f ~/HealthData/DBs/garmin.db ]; then
              echo "import_status=no_new_data" >> $GITHUB_OUTPUT
              echo "sync_mode=${SYNC_MODE}" >> $GITHUB_OUTPUT
              echo "âš ï¸ Garmin data import returned exit code $exit_code"
              echo "However, database exists from previous run. Will sync existing data."
              exit 0
            else
              echo "import_status=failed" >> $GITHUB_OUTPUT
              echo "âŒ Garmin data import failed and no database exists"
              exit 1
            fi
          fi
      
      - name: Sync to BigQuery
        # Run if import was successful OR if import had no new data but database exists
        if: steps.import_data.outputs.import_status == 'success' || steps.import_data.outputs.import_status == 'no_new_data'
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          DATASET_ID: garmin_data
          SYNC_MODE: ${{ steps.import_data.outputs.sync_mode }}
        run: |
          echo "Sync mode: ${SYNC_MODE}"

          if [ "${SYNC_MODE}" == "full_refresh" ]; then
            echo "ğŸ”„ Full refresh: replacing all data in BigQuery..."
          else
            echo "ğŸ”€ Incremental: using MERGE (upsert) to prevent duplicates..."
          fi

          if python sync_bq.py; then
            echo "âœ… BigQuery sync completed successfully"
          else
            echo "âŒ BigQuery sync failed"
            exit 1
          fi
      
      - name: Display sync summary
        if: steps.import_data.outputs.import_status == 'success' || steps.import_data.outputs.import_status == 'no_new_data'
        run: |
          echo "ğŸ“Š Sync completed for dataset: garmin_data"
          echo "Check the logs above for detailed row counts per table"
