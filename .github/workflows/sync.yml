name: Sync Garmin Data to BigQuery

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache GarminDB data
        uses: actions/cache@v4
        with:
          path: ~/.GarminDb
          # Use date-based key to cache data for the day, allowing updates within the same day
          key: garmindb-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}-${{ github.run_number }}
          restore-keys: |
            garmindb-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}-
            garmindb-${{ runner.os }}-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Configure Garmin credentials
        run: |
          mkdir -p ~/.GarminDb
          cat > ~/.GarminDb/GarminConnectConfig.json << EOF
          {
            "credentials": {
              "user": "${{ secrets.GARMIN_USER }}",
              "password": "${{ secrets.GARMIN_PASSWORD }}"
            }
          }
          EOF
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Import Garmin data
        continue-on-error: true
        run: |
          # Import and analyze latest Garmin data
          # Allow this to fail in case of auth issues or no new data
          garmindb_cli.py --import --analyze --latest || echo "Import failed or no new data available"
      
      - name: Sync to BigQuery
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          DATASET_ID: garmin_data
        run: |
          python sync_bq.py
