name: Sync All Years (Auto Sequential)

on:
  schedule:
    # Run every 5 hours to continue next batch
    - cron: '0 */5 * * *'

  workflow_dispatch:
    inputs:
      batch:
        description: 'Which batch to run'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - '1-2015-2017'
          - '2-2018-2020'
          - '3-2021-2023'
          - '4-2024-2025'
          - done

jobs:
  sync-next-batch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check sync status
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            // Get recent workflow runs for sync.yml
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'sync.yml',
              per_page: 5
            });

            // Check if any sync is currently running
            const runningSync = runs.data.workflow_runs.find(r =>
              r.status === 'in_progress' || r.status === 'queued'
            );

            if (runningSync) {
              console.log('A sync is currently running, skipping...');
              core.setOutput('action', 'skip');
              core.setOutput('reason', 'sync_running');
              return;
            }

            // Check the most recent completed run
            const lastRun = runs.data.workflow_runs.find(r => r.status === 'completed');

            if (lastRun && lastRun.conclusion === 'failure') {
              console.log('Last sync failed! Not proceeding to next batch.');
              console.log(`Failed run: ${lastRun.html_url}`);
              core.setOutput('action', 'skip');
              core.setOutput('reason', 'last_failed');
              return;
            }

            core.setOutput('action', 'proceed');
            core.setOutput('reason', 'ok');

      - name: Read current batch
        if: steps.check.outputs.action == 'proceed'
        id: state
        run: |
          if [ -f .github/sync-batch-state.txt ]; then
            BATCH=$(cat .github/sync-batch-state.txt)
          else
            BATCH="0"
          fi

          # Override if manually specified
          if [ "${{ inputs.batch }}" != "auto" ] && [ "${{ inputs.batch }}" != "" ]; then
            case "${{ inputs.batch }}" in
              "1-2015-2017") BATCH="0" ;;
              "2-2018-2020") BATCH="1" ;;
              "3-2021-2023") BATCH="2" ;;
              "4-2024-2025") BATCH="3" ;;
              "done") BATCH="4" ;;
            esac
          fi

          echo "current_batch=$BATCH" >> $GITHUB_OUTPUT
          echo "Current batch state: $BATCH"

      - name: Run batch 1 (2015-2017)
        if: steps.check.outputs.action == 'proceed' && steps.state.outputs.current_batch == '0'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'sync.yml',
              ref: 'main',
              inputs: {
                sync_mode: 'year_range',
                start_year: '2015',
                end_year: '2017',
                replace_tables: 'true'
              }
            });
            console.log('‚úÖ Triggered 2015-2017 sync (replace=true)');

      - name: Run batch 2 (2018-2020)
        if: steps.check.outputs.action == 'proceed' && steps.state.outputs.current_batch == '1'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'sync.yml',
              ref: 'main',
              inputs: {
                sync_mode: 'year_range',
                start_year: '2018',
                end_year: '2020',
                replace_tables: 'false'
              }
            });
            console.log('‚úÖ Triggered 2018-2020 sync');

      - name: Run batch 3 (2021-2023)
        if: steps.check.outputs.action == 'proceed' && steps.state.outputs.current_batch == '2'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'sync.yml',
              ref: 'main',
              inputs: {
                sync_mode: 'year_range',
                start_year: '2021',
                end_year: '2023',
                replace_tables: 'false'
              }
            });
            console.log('‚úÖ Triggered 2021-2023 sync');

      - name: Run batch 4 (2024-2025)
        if: steps.check.outputs.action == 'proceed' && steps.state.outputs.current_batch == '3'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'sync.yml',
              ref: 'main',
              inputs: {
                sync_mode: 'year_range',
                start_year: '2024',
                end_year: '2025',
                replace_tables: 'false'
              }
            });
            console.log('‚úÖ Triggered 2024-2025 sync');

      - name: Update batch state
        if: steps.check.outputs.action == 'proceed' && steps.state.outputs.current_batch != '4'
        run: |
          CURRENT=${{ steps.state.outputs.current_batch }}
          NEXT=$((CURRENT + 1))
          echo "$NEXT" > .github/sync-batch-state.txt

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/sync-batch-state.txt
          git commit -m "Update sync batch state to $NEXT" || echo "No changes"
          git push || echo "Push failed, will retry next run"

      - name: All done
        if: steps.check.outputs.action == 'proceed' && steps.state.outputs.current_batch == '4'
        run: |
          echo "üéâ All batches complete!"
          echo "You can now re-enable the daily schedule in sync.yml"

      - name: Status report
        run: |
          echo "================================"
          echo "Action: ${{ steps.check.outputs.action }}"
          echo "Reason: ${{ steps.check.outputs.reason }}"
          echo "Current batch: ${{ steps.state.outputs.current_batch || 'N/A' }}"
          echo "================================"
          if [ "${{ steps.check.outputs.reason }}" == "last_failed" ]; then
            echo "‚ö†Ô∏è  Last sync failed. Fix the issue and re-run manually."
          fi
