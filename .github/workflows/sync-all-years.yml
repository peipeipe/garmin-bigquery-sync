name: Sync All Years (Auto Sequential)

on:
  schedule:
    # Run every 5 hours to continue next batch
    - cron: '0 */5 * * *'

  workflow_dispatch:
    inputs:
      batch:
        description: 'Which batch to run'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - '1-2015-2017'
          - '2-2018-2020'
          - '3-2021-2023'
          - '4-2024-2025'
          - done

jobs:
  sync-next-batch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if sync is running
        id: running
        uses: actions/github-script@v7
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'sync.yml',
              status: 'in_progress',
              per_page: 5
            });
            const isRunning = runs.data.total_count > 0;
            console.log(`Sync running: ${isRunning}`);
            core.setOutput('is_running', isRunning);

      - name: Read current batch
        if: steps.running.outputs.is_running == 'false'
        id: state
        run: |
          if [ -f .github/sync-batch-state.txt ]; then
            BATCH=$(cat .github/sync-batch-state.txt)
          else
            BATCH="0"
          fi

          # Override if manually specified
          if [ "${{ inputs.batch }}" != "auto" ] && [ "${{ inputs.batch }}" != "" ]; then
            case "${{ inputs.batch }}" in
              "1-2015-2017") BATCH="0" ;;
              "2-2018-2020") BATCH="1" ;;
              "3-2021-2023") BATCH="2" ;;
              "4-2024-2025") BATCH="3" ;;
              "done") BATCH="4" ;;
            esac
          fi

          echo "current_batch=$BATCH" >> $GITHUB_OUTPUT
          echo "Current batch state: $BATCH"

      - name: Run batch 1 (2015-2017)
        if: steps.running.outputs.is_running == 'false' && steps.state.outputs.current_batch == '0'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'sync.yml',
              ref: 'main',
              inputs: {
                sync_mode: 'year_range',
                start_year: '2015',
                end_year: '2017',
                replace_tables: 'true'
              }
            });
            console.log('âœ… Triggered 2015-2017 sync (replace=true)');

      - name: Run batch 2 (2018-2020)
        if: steps.running.outputs.is_running == 'false' && steps.state.outputs.current_batch == '1'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'sync.yml',
              ref: 'main',
              inputs: {
                sync_mode: 'year_range',
                start_year: '2018',
                end_year: '2020',
                replace_tables: 'false'
              }
            });
            console.log('âœ… Triggered 2018-2020 sync');

      - name: Run batch 3 (2021-2023)
        if: steps.running.outputs.is_running == 'false' && steps.state.outputs.current_batch == '2'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'sync.yml',
              ref: 'main',
              inputs: {
                sync_mode: 'year_range',
                start_year: '2021',
                end_year: '2023',
                replace_tables: 'false'
              }
            });
            console.log('âœ… Triggered 2021-2023 sync');

      - name: Run batch 4 (2024-2025)
        if: steps.running.outputs.is_running == 'false' && steps.state.outputs.current_batch == '3'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'sync.yml',
              ref: 'main',
              inputs: {
                sync_mode: 'year_range',
                start_year: '2024',
                end_year: '2025',
                replace_tables: 'false'
              }
            });
            console.log('âœ… Triggered 2024-2025 sync');

      - name: Update batch state
        if: steps.running.outputs.is_running == 'false' && steps.state.outputs.current_batch != '4'
        run: |
          CURRENT=${{ steps.state.outputs.current_batch }}
          NEXT=$((CURRENT + 1))
          echo "$NEXT" > .github/sync-batch-state.txt

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/sync-batch-state.txt
          git commit -m "Update sync batch state to $NEXT" || echo "No changes"
          git push || echo "Push failed, will retry next run"

      - name: All done
        if: steps.state.outputs.current_batch == '4'
        run: |
          echo "ðŸŽ‰ All batches complete!"
          echo "You can now re-enable the daily schedule in sync.yml"
